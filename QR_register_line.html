<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refer-Friend</title>
    <!-- โหลด Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        /* (เพิ่ม) สไตล์สำหรับช่อง OTP Input */
        .otp-input {
            transition: all 0.15s ease-in-out;
        }
        .otp-input:disabled {
            background-color: #f3f4f6; /* bg-gray-100 */
        }
        .img {
              margin: 15px auto !important;
        }
    </style>
</head>
<!-- (แก้ไข) ปรับ margin-top (pt-8 = 2rem) -->
<body class="bg-white flex flex-col items-center justify-center min-h-screen pt-8 pb-10" style="background-color: #dee1e1;">

    <!-- กล่องลงทะเบียน -->
    <!-- (แก้ไข) เปลี่ยน bg-gray-50 เป็น bg-white และเพิ่ม 'relative' สำหรับ Overlay -->
    <div id="registrationFormContainer" class="w-[95%] max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md transition-colors duration-300 relative">
        <h1 class="text-2xl font-bold text-center text-gray-900">ลงทะเบียนกิจกรรม</h1>
        <!-- *** แก้ไข: เพิ่ม id="eventDate" *** -->
        <p id="eventDate" class="text-sm font-medium text-gray-700 text-center" style="margin-top: 2px;">วันที่ 18 พฤศจิกายน 2568</p>

        <!-- *** แก้ไข: เพิ่ม id="eventImageContainer" *** -->
        <!-- (แก้ไข) เปลี่ยน mt-6 เป็น my-4 (margin top/bottom 16px) -->
        <div id="eventImageContainer" class="my-4 w-[70%] mx-auto">
            <img src="./images/event.png">
        </div>
              
        <!-- *** (แก้ไข) ปรับปรุงโครงสร้างการแสดงข้อมูลพนักงาน *** -->
        <div id="employeeInfoDisplay" class="hidden text-center space-y-2 py-4">
            <!-- 1. ชื่อ-นามสกุล (Name) (รหัสพนักงาน) (EmpID) -->
            <p id="infoFullName" class="text-lg font-bold text-gray-900"></p> 
            
            <!-- (แก้ไข) 2. (Chief) แทนที่ EmpZoneRH -->
            <p id="infoChief" class="text-base text-gray-700"></p>
            
            <!-- 3. กล่องลงทะเบียนสำเร็จ + DateLogin (NEW STRUCTURE) -->
            <div id="registrationSuccessBox" class="mt-4 p-3 bg-green-100 border border-green-300 rounded-lg shadow-sm">
                <p class="text-lg font-extrabold text-green-700">ลงทะเบียนสำเร็จ</p> 
                <!-- (แก้ไข) ย้าย DateLogin เข้ามาในกล่องสำเร็จ (สีเทาเข้ม, ตัวเล็ก) -->
                <p id="infoDateLogin" class="text-xs font-medium text-gray-600 mt-1"></p> 
            </div>
            
            <!-- (เพิ่ม) 4. แสดงสถานะรางวัล / กล่องรางวัลพิเศษ (จะถูกแทนที่ด้วยปุ่มยืนยันหากมีการตั้งค่า) -->
            <p id="rewardStatusMessage" class="text-sm font-semibold text-gray-700 pt-2"></p>
        </div>

        <!-- ฟอร์มลงทะเบียน -->
        <form id="registrationForm" class="space-y-4">
            
            <!-- (แก้ไข) เปลี่ยนเป็นช่อง OTP 5 ช่อง -->
            <div>
                <!-- (ลบ) ลบ Label "รหัสพนักงาน" -->
                <div id="otpContainer" class="flex justify-center gap-1 sm:gap-2">
                    <!-- (แก้ไข) เพิ่มขนาดตัวอักษรเป็น text-2xl -->
                    <input type="tel" maxlength="1" class="otp-input w-9 h-11 sm:w-10 sm:h-12 text-center text-2xl font-semibold border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    <input type="tel" maxlength="1" class="otp-input w-9 h-11 sm:w-10 sm:h-12 text-center text-2xl font-semibold border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    <input type="tel" maxlength="1" class="otp-input w-9 h-11 sm:w-10 sm:h-12 text-center text-2xl font-semibold border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    <input type="tel" maxlength="1" class="otp-input w-9 h-11 sm:w-10 sm:h-12 text-center text-2xl font-semibold border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    <input type="tel" maxlength="1" class="otp-input w-9 h-11 sm:w-10 sm:h-12 text-center text-2xl font-semibold border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
                <!-- (เพิ่ม) Helper text และเว้นช่องว่างด้านล่าง (mb-4) -->
                <div style="height:5px;"></div>
                <p class="text-xs text-gray-500 text-center mt-2 mb-4">ใส่รหัสพนักงานของคุณให้ถูกต้องก่อนกด ลงทะเบียน</p>
            </div>
            
            <!-- (ลบ) ช่องชื่อเล่น -->
            
            <button type="button" id="registerButton"
                    class="w-full px-4 py-2 font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out disabled:bg-gray-400"
                    disabled> <!-- (เพิ่ม) disabled ปุ่มไว้ตอนเริ่ม -->
                ลงทะเบียน
            </button>
        </form>
        
        <!-- NEW: Reward Count Display -->
        <div id="rewardCountDisplay" class="text-center text-sm mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-md">
            <p class="text-gray-700">
                รางวัลคงเหลือ: <span id="rewardCountValue" class="font-bold text-red-600">กำลังโหลด...</span> รายการ
            </p>
        </div>

        <!-- พื้นที่แสดงข้อความ (สำหรับข้อผิดพลาดหลัก) --><div id="message" class="text-center text-sm"></div>

        <!-- (ลบ) ลบส่วนแสดงข้อความลงทะเบียนสำเร็จ (teamDisplay) -->
        <div id="teamDisplay" class="hidden text-center border-t pt-4 mt-4">
            <h2 id="teamNameDisplay" class="text-8xl font-bold text-[#0056ff]"></h2> 
            <p class="text-sm font-medium text-gray-700 mt-1">ทีมของคุณ</p>
            
            <p id="registrationStatusMessage" class="text-sm mt-4"></p>
            <p id="registrationTimestamp" class="text-xs text-gray-500"></p>
        </div>

        <!-- (เพิ่ม) Loading Overlay สำหรับ Spinner -->
        <div id="loadingOverlay" class="hidden absolute inset-0 bg-white bg-opacity-80 flex flex-col items-center justify-center space-y-4 rounded-lg z-20">
            <svg class="animate-spin h-12 w-12 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <!-- (แก้ไข) ปรับเลข Countdown เริ่มต้นเป็น 3 -->
            <p class="text-lg font-medium text-gray-700">กำลังตรวจสอบข้อมูล... <span id="spinnerCountdown">3</span></p>
        </div>
    </div>

    <!-- (เพิ่ม) Lightbox (Modal) สำหรับแจ้งเตือน Error -->
    <div id="errorLightbox" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
            <!-- (แก้ไข) ปรับขนาด Font จาก text-base เป็น text-sm -->
            <p id="errorLightboxMessage" class="text-sm text-gray-800 mb-6">ไม่พบรหัสพนักงานนี้ในระบบ<br>กรุณากรอกรหัสพนักงานใหม่อีกครั้ง</p>
            <button id="closeLightboxButton" class="w-full px-4 py-2 font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                ปิด
            </button>
        </div>
    </div>

    <!-- Firebase SDK และการเชื่อมต่อ --><script type="module">
        // นำเข้า Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // (แก้ไข) เพิ่ม getDoc และ runTransaction
        import { getFirestore, collection, getDocs, query, where, serverTimestamp, setLogLevel, limit, doc, updateDoc, or, getDoc, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"; 

        // --- *** ข้อสำคัญ: สำหรับแก้ไข "Missing or insufficient permissions." *** ---
        // (ส่วนนี้เหมือนเดิม)
        // ... (Security Rules comment block) ...
        // --- *************************************************************** ---


        // --- *** 1. ใส่ Firebase Config ของคุณที่นี่ *** ---
const _0xa5397d=_0x5d8c;function _0x5d8c(_0x3597c7,_0x9ba18){const _0x5018d3=_0x5018();return _0x5d8c=function(_0x5d8c3d,_0x1c5254){_0x5d8c3d=_0x5d8c3d-0x152;let _0x3cd7f8=_0x5018d3[_0x5d8c3d];return _0x3cd7f8;},_0x5d8c(_0x3597c7,_0x9ba18);}(function(_0x3d6541,_0x32ad42){const _0x355fae=_0x5d8c,_0x4f81b1=_0x3d6541();while(!![]){try{const _0x881782=-parseInt(_0x355fae(0x19c))/0x1+parseInt(_0x355fae(0x16d))/0x2*(parseInt(_0x355fae(0x179))/0x3)+-parseInt(_0x355fae(0x1b0))/0x4*(parseInt(_0x355fae(0x187))/0x5)+parseInt(_0x355fae(0x1b5))/0x6+-parseInt(_0x355fae(0x1bc))/0x7+parseInt(_0x355fae(0x19d))/0x8+parseInt(_0x355fae(0x188))/0x9;if(_0x881782===_0x32ad42)break;else _0x4f81b1['push'](_0x4f81b1['shift']());}catch(_0x9b57a2){_0x4f81b1['push'](_0x4f81b1['shift']());}}}(_0x5018,0xae520));const firebaseConfig={'apiKey':_0xa5397d(0x19e),'authDomain':'ttb-register.firebaseapp.com','databaseURL':_0xa5397d(0x1b1),'projectId':_0xa5397d(0x18a),'storageBucket':_0xa5397d(0x168),'messagingSenderId':_0xa5397d(0x183),'appId':_0xa5397d(0x16a),'measurementId':'G-9DJLWJ5LQW'},configCollectionName=_0xa5397d(0x193);function _0x5018(){const _0x4e4de9=['Firebase\x20initialization\x20failed:','ลงทะเบียนเมื่อ:\x20','9ZtsCnB','log','empty','set','bg-green-600','registrationForm','ข้อผิดพลาด','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22mt-4\x20p-3\x20bg-indigo-100\x20border\x20border-indigo-300\x20rounded-lg\x20shadow-sm\x20text-gray-800\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20class=\x22text-lg\x20font-extrabold\x20text-indigo-700\x22>คุณได้รับรางวัลพิเศษ</p>\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<!--\x20NEW\x20BUTTON\x20-->\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20type=\x22button\x22\x20id=\x22confirmRewardButton\x22\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20class=\x22w-full\x20mt-3\x20px-4\x20py-2\x20font-medium\x20text-white\x20rounded-md\x20transition\x20duration-150\x20ease-in-out\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','open_reward','text-gray-600','1070273157855','message','update','error','410295xvjIaN','5537925xkoHpD','Reward\x20Transaction\x20failed:','ttb-register','innerHTML','DateLogin','value','spinnerCountdown','disabled','rewardStatusMessage','hidden','classList','data_reward','select','DateConfirm','employeeInfoDisplay','getElementById','closeLightboxButton','RewardGranted','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','input','1419158NlvYmi','10719280OIlqZp','AIzaSyAgWMzWcZPzyzoBu5eQzj2y59nKsxTWurQ','Error\x20fetching\x20reward\x20config:','กำลังตรวจสอบ...','textContent','N/A','forEach','main','toDate','ลงทะเบียน','เกิดข้อผิดพลาด\x20(ลองอีกครั้ง)','Registration\x20Logged\x20successfully\x20(DateLogin\x20updated).','Signed\x20in\x20anonymously','function','Employee\x20document\x20ID\x20is\x20missing\x20for\x20confirmation.','get','ข้อผิดพลาด:\x20ไม่พบ\x20ID\x20พนักงาน\x20กรุณาลงทะเบียนใหม่','preventDefault','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20class=\x22text-xs\x20text-gray-600\x20mt-2\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','48TfhYgT','https://ttb-register-default-rtdb.asia-southeast1.firebasedatabase.app','loadingOverlay','focus','addEventListener','5737818OAqWqb','toLocaleString','Name','confirmRewardButton','bg-gray-500','warn','text-red-600','214109CtbGPS','data','employeeId','bg-blue-200','teamNameDisplay','registrationFormContainer','กรุณากรอกรหัสพนักงานให้ครบ\x205\x20หลัก','EmpID','กำลังบันทึก...','ไม่พบข้อมูล','number_extra','rewardCountValue','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20class=\x22font-bold\x20text-red-700\x22>เกิดข้อผิดพลาด:\x20ไม่มีสิทธิ์\x20(Missing\x20or\x20insufficient\x20permissions)</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20class=\x22mt-2\x20text-sm\x20text-gray-700\x22>ปัญหานี้เกิดจาก\x20Security\x20Rules\x20ใน\x20Firebase\x20ของคุณ</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20class=\x22mt-1\x20text-sm\x20text-gray-700\x22>กรุณาดู\x20<strong\x20class=\x22text-black\x22>\x22ข้อสำคัญ\x22</strong>\x20ในคอมเมนต์\x20(หมายเหตุ)\x20ในไฟล์นี้</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20class=\x22mt-1\x20text-sm\x20text-gray-700\x22>ซึ่งอยู่ที่ประมาณบรรทัดที่\x20113\x20เพื่อดูวิธีแก้ไขครับ</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','otpContainer','target','th-TH','trim','long','exists','from','\x22\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','teamDisplay','ไม่มีข้อมูล','pt-2','ยืนยันการรับรางวัล','className','text-center\x20text-sm\x20text-red-600','clipboardData','length','registerButton','text-green-600','border-red-500','remove','registrationTimestamp','match','data_employee','infoDateLogin','Error\x20logging\x20registration:\x20','then','ลงทะเบียนซ้ำ','ลงทะเบียนสำเร็จ','paste','click','querySelectorAll','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22mt-4\x20p-3\x20bg-yellow-100\x20border\x20border-yellow-300\x20rounded-lg\x20shadow-sm\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20class=\x22text-lg\x20font-extrabold\x20text-yellow-800\x22>คุณได้รับรางวัลพิเศษ</p>\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20class=\x22text-sm\x20font-medium\x20text-yellow-700\x20mt-1\x22>รับรางวัลเมื่อจบกิจกรรม</p>\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','registrationStatusMessage','Reward\x20configuration\x20document\x20not\x20found.\x20Cannot\x20process\x20reward.','ttb-register.firebasestorage.app','number','1:1070273157855:web:5c8120e1df27e233d8676a','replace','Error\x20logging\x20DateConfirm:\x20','157954ZiiLlo','text-center\x20text-sm\x20p-3\x20bg-red-50\x20border\x20border-red-200\x20rounded-md','errorLightboxMessage','bg-gray-100','getData','eventDate','Field\x20\x27number_extra\x27\x20is\x20missing\x20or\x20not\x20a\x20number\x20in\x20data_reward/main\x20doc.','add','Backspace','docs'];_0x5018=function(){return _0x4e4de9;};return _0x5018();}let db,auth,currentEmployeeDocId=null,openRewardStatus=0x0;const registrationFormContainer=document['getElementById'](_0xa5397d(0x1c1)),otpContainer=document[_0xa5397d(0x197)](_0xa5397d(0x1c9)),otpInputs=otpContainer?Array[_0xa5397d(0x1cf)](otpContainer[_0xa5397d(0x164)]('.otp-input')):[],registerButton=document['getElementById'](_0xa5397d(0x156)),messageDiv=document[_0xa5397d(0x197)](_0xa5397d(0x184)),teamDisplay=document[_0xa5397d(0x197)](_0xa5397d(0x1d1)),teamNameDisplay=document[_0xa5397d(0x197)](_0xa5397d(0x1c0)),regStatusMsg=document[_0xa5397d(0x197)](_0xa5397d(0x166)),regTimestamp=document[_0xa5397d(0x197)](_0xa5397d(0x15a)),eventDate=document[_0xa5397d(0x197)](_0xa5397d(0x172)),eventImageContainer=document[_0xa5397d(0x197)]('eventImageContainer'),registrationForm=document[_0xa5397d(0x197)](_0xa5397d(0x17e)),employeeInfoDisplay=document[_0xa5397d(0x197)](_0xa5397d(0x196)),infoFullName=document['getElementById']('infoFullName'),infoChief=document[_0xa5397d(0x197)]('infoChief'),registrationSuccessBox=document[_0xa5397d(0x197)]('registrationSuccessBox'),infoDateLogin=document['getElementById'](_0xa5397d(0x15d)),rewardStatusMessage=document[_0xa5397d(0x197)](_0xa5397d(0x190)),rewardCountDisplay=document[_0xa5397d(0x197)]('rewardCountDisplay'),rewardCountValue=document[_0xa5397d(0x197)](_0xa5397d(0x1c7)),loadingOverlay=document[_0xa5397d(0x197)](_0xa5397d(0x1b2)),spinnerCountdown=document[_0xa5397d(0x197)](_0xa5397d(0x18e)),errorLightbox=document[_0xa5397d(0x197)]('errorLightbox'),errorLightboxMessage=document[_0xa5397d(0x197)](_0xa5397d(0x16f)),closeLightboxButton=document[_0xa5397d(0x197)](_0xa5397d(0x198));let countdownInterval;function alertLightbox(_0x3a9682){const _0x1bc5f9=_0xa5397d;errorLightboxMessage[_0x1bc5f9(0x18b)]=_0x3a9682,errorLightbox[_0x1bc5f9(0x192)][_0x1bc5f9(0x159)](_0x1bc5f9(0x191));}function checkOtpCompleteness(){const _0x2f517c=_0xa5397d;let _0x5b02aa=!![];otpInputs[_0x2f517c(0x1a3)](_0x30f7d7=>{const _0x2e74ee=_0x2f517c;_0x30f7d7[_0x2e74ee(0x18d)][_0x2e74ee(0x1cc)]()[_0x2e74ee(0x155)]===0x0&&(_0x5b02aa=![]);}),registerButton[_0x2f517c(0x18f)]=!_0x5b02aa;}function getRewardConfigRef(){const _0x5c8ba8=_0xa5397d;return doc(db,configCollectionName,_0x5c8ba8(0x1a4));}async function fetchRewardConfig(){const _0x546ad3=_0xa5397d;if(!db){console[_0x546ad3(0x1ba)]('[RewardConfig]\x20Firestore\x20not\x20initialized.'),rewardCountValue[_0x546ad3(0x1a1)]=_0x546ad3(0x17f);return;}try{const _0x426708=getRewardConfigRef(),_0xeaaff4=await getDoc(_0x426708);if(_0xeaaff4[_0x546ad3(0x1ce)]()){const _0x2ff220=_0xeaaff4['data'](),_0x2cc859=_0x2ff220[_0x546ad3(0x1c6)];openRewardStatus=_0x2ff220[_0x546ad3(0x181)]||0x0,typeof _0x2cc859===_0x546ad3(0x169)?_0x2cc859===0x0?rewardCountDisplay['classList']['add'](_0x546ad3(0x191)):(rewardCountDisplay[_0x546ad3(0x192)][_0x546ad3(0x159)](_0x546ad3(0x191)),rewardCountValue[_0x546ad3(0x1a1)]=_0x2cc859[_0x546ad3(0x1b6)]('th-TH')):(rewardCountDisplay[_0x546ad3(0x192)][_0x546ad3(0x159)](_0x546ad3(0x191)),rewardCountValue[_0x546ad3(0x1a1)]='ไม่ระบุ',console[_0x546ad3(0x1ba)](_0x546ad3(0x173)));}else rewardCountDisplay['classList'][_0x546ad3(0x174)]('hidden'),rewardCountValue[_0x546ad3(0x1a1)]=_0x546ad3(0x1c5),console[_0x546ad3(0x1ba)]('Reward\x20configuration\x20document\x20(data_reward/main)\x20not\x20found.');}catch(_0x496269){console[_0x546ad3(0x186)](_0x546ad3(0x19f),_0x496269),rewardCountDisplay[_0x546ad3(0x192)][_0x546ad3(0x159)](_0x546ad3(0x191)),rewardCountValue[_0x546ad3(0x1a1)]=_0x546ad3(0x17f);}}try{const app=initializeApp(firebaseConfig);db=getFirestore(app),auth=getAuth(app),setLogLevel('Debug'),signInAnonymously(auth)[_0xa5397d(0x15f)](()=>{const _0x1cb058=_0xa5397d;console[_0x1cb058(0x17a)](_0x1cb058(0x1a9)),fetchRewardConfig();}),otpInputs[_0xa5397d(0x155)]>0x0&&otpInputs[0x0][_0xa5397d(0x1b3)](),closeLightboxButton[_0xa5397d(0x1b4)](_0xa5397d(0x163),()=>{const _0x55f727=_0xa5397d;errorLightbox['classList'][_0x55f727(0x174)]('hidden'),registerButton[_0x55f727(0x18f)]=![],registerButton[_0x55f727(0x1a1)]=_0x55f727(0x1a6),otpInputs[_0x55f727(0x1a3)](_0x3c486e=>{const _0x33ecca=_0x55f727;_0x3c486e[_0x33ecca(0x18f)]=![],_0x3c486e[_0x33ecca(0x192)][_0x33ecca(0x159)](_0x33ecca(0x170)),_0x3c486e[_0x33ecca(0x192)][_0x33ecca(0x159)](_0x33ecca(0x1bf)),_0x3c486e[_0x33ecca(0x18d)]='';}),otpInputs['length']>0x0&&otpInputs[0x0][_0x55f727(0x1b3)](),checkOtpCompleteness();});}catch(_0x60032e){console[_0xa5397d(0x186)](_0xa5397d(0x177),_0x60032e),document[_0xa5397d(0x197)](_0xa5397d(0x184))['textContent']='เกิดข้อผิดพลาดในการเชื่อมต่อฐานข้อมูล:\x20'+_0x60032e[_0xa5397d(0x184)];}registerButton[_0xa5397d(0x1b4)](_0xa5397d(0x163),handleRegisterCheck);otpContainer&&otpInputs['forEach']((_0x298abd,_0x4b1265)=>{const _0x51d1b5=_0xa5397d;_0x298abd[_0x51d1b5(0x1b4)](_0x51d1b5(0x19b),_0x159112=>{const _0x11b383=_0x51d1b5;_0x298abd[_0x11b383(0x18d)]=_0x298abd[_0x11b383(0x18d)][_0x11b383(0x16b)](/[^0-9]/g,'');const _0x238c5e=_0x298abd[_0x11b383(0x18d)];if(_0x238c5e['length']===0x1)_0x298abd[_0x11b383(0x192)][_0x11b383(0x174)]('bg-blue-200'),_0x4b1265<otpInputs[_0x11b383(0x155)]-0x1&&otpInputs[_0x4b1265+0x1][_0x11b383(0x1b3)]();else _0x238c5e[_0x11b383(0x155)]===0x0&&_0x298abd['classList']['remove'](_0x11b383(0x1bf));checkOtpCompleteness();}),_0x298abd[_0x51d1b5(0x1b4)]('keydown',_0x30ac69=>{const _0x9e0d3a=_0x51d1b5;_0x30ac69['key']===_0x9e0d3a(0x175)&&_0x298abd[_0x9e0d3a(0x18d)]===''&&_0x4b1265>0x0&&(_0x30ac69[_0x9e0d3a(0x1ae)](),otpInputs[_0x4b1265-0x1]['focus'](),otpInputs[_0x4b1265-0x1][_0x9e0d3a(0x194)]());}),_0x298abd[_0x51d1b5(0x1b4)](_0x51d1b5(0x162),_0x2bdee0=>{const _0x5ae82d=_0x51d1b5;_0x2bdee0['preventDefault']();const _0x5a8320=_0x2bdee0[_0x5ae82d(0x154)][_0x5ae82d(0x171)]('text')[_0x5ae82d(0x1cc)]()[_0x5ae82d(0x16b)](/[^0-9]/g,'');if(_0x5a8320[_0x5ae82d(0x155)]===otpInputs['length'])otpInputs['forEach']((_0x533378,_0x43147c)=>{const _0xe7272f=_0x5ae82d;_0x533378[_0xe7272f(0x18d)]=_0x5a8320[_0x43147c]||'',_0x533378[_0xe7272f(0x18d)]?_0x533378[_0xe7272f(0x192)][_0xe7272f(0x174)](_0xe7272f(0x1bf)):_0x533378[_0xe7272f(0x192)][_0xe7272f(0x159)](_0xe7272f(0x1bf));}),otpInputs[otpInputs[_0x5ae82d(0x155)]-0x1]['focus']();else{if(_0x5a8320[_0x5ae82d(0x155)]>0x0){let _0x2a9d76=_0x4b1265;for(let _0x27d782=0x0;_0x27d782<_0x5a8320[_0x5ae82d(0x155)]&&_0x2a9d76<otpInputs[_0x5ae82d(0x155)];_0x27d782++){otpInputs[_0x2a9d76][_0x5ae82d(0x18d)]=_0x5a8320[_0x27d782],otpInputs[_0x2a9d76]['classList']['add'](_0x5ae82d(0x1bf)),_0x2a9d76<otpInputs['length']-0x1&&otpInputs[_0x2a9d76+0x1][_0x5ae82d(0x1b3)](),_0x2a9d76++;}}}setTimeout(checkOtpCompleteness,0x0);}),_0x298abd[_0x51d1b5(0x1b4)]('focus',_0x4cfb38=>{const _0x5340ff=_0x51d1b5;_0x4cfb38[_0x5340ff(0x1ca)]['select']();});});function formatThaiTimestamp(_0x24051e){const _0x3f7d78=_0xa5397d,_0x40694c=_0x24051e&&typeof _0x24051e[_0x3f7d78(0x1a5)]===_0x3f7d78(0x1aa)?_0x24051e[_0x3f7d78(0x1a5)]():_0x24051e;if(_0x40694c instanceof Date&&!isNaN(_0x40694c))return _0x40694c['toLocaleString'](_0x3f7d78(0x1cb),{'dateStyle':_0x3f7d78(0x1cd),'timeStyle':'medium'});return _0x3f7d78(0x1d2);}async function handleRewardConfirm(){const _0x31dc24=_0xa5397d,_0x33cab3=currentEmployeeDocId;if(!_0x33cab3){console['error'](_0x31dc24(0x1ab)),alertLightbox(_0x31dc24(0x1ad));return;}const _0x42191b=document['getElementById'](_0x31dc24(0x1b8));_0x42191b&&(_0x42191b[_0x31dc24(0x18f)]=!![],_0x42191b[_0x31dc24(0x1a1)]=_0x31dc24(0x1c4),_0x42191b[_0x31dc24(0x192)][_0x31dc24(0x159)](_0x31dc24(0x17d),'hover:bg-green-700'),_0x42191b[_0x31dc24(0x192)][_0x31dc24(0x174)](_0x31dc24(0x1b9)));try{const _0x2a9d32=doc(db,_0x31dc24(0x15c),_0x33cab3);await updateDoc(_0x2a9d32,{'DateConfirm':serverTimestamp()}),console[_0x31dc24(0x17a)]('Reward\x20confirmation\x20(DateConfirm)\x20logged\x20successfully.');const _0x11a069=infoFullName['textContent'][_0x31dc24(0x15b)](/\(([^)]+)\)/)?.[0x1];if(_0x11a069){let _0x17df51=await getCrsgDoc(_0x11a069);_0x17df51&&displayEmployeeInfo(_0x17df51[_0x31dc24(0x1bd)],_0x11a069,![]);}}catch(_0x22c966){console[_0x31dc24(0x186)](_0x31dc24(0x16c),_0x22c966),alertLightbox('เกิดข้อผิดพลาดในการบันทึกยืนยัน:\x20'+_0x22c966['message']),_0x42191b&&(_0x42191b[_0x31dc24(0x18f)]=![],_0x42191b[_0x31dc24(0x1a1)]=_0x31dc24(0x1a7),_0x42191b[_0x31dc24(0x192)][_0x31dc24(0x159)](_0x31dc24(0x1b9)),_0x42191b[_0x31dc24(0x192)]['add']('bg-red-600'));}}function handleRegisterCheck(){const _0x3c1785=_0xa5397d;let _0x27bfd3='';otpInputs['forEach'](_0x587816=>{const _0x35efe4=_0x5d8c;_0x27bfd3+=_0x587816['value'][_0x35efe4(0x1cc)]();}),otpInputs[_0x3c1785(0x1a3)](_0x1237e2=>_0x1237e2['classList'][_0x3c1785(0x159)](_0x3c1785(0x158)));if(_0x27bfd3[_0x3c1785(0x155)]<0x5){messageDiv['textContent']=_0x3c1785(0x1c2),messageDiv[_0x3c1785(0x152)]=_0x3c1785(0x153),otpInputs[_0x3c1785(0x1a3)](_0x297bf5=>{const _0x17916f=_0x3c1785;!_0x297bf5[_0x17916f(0x18d)]&&_0x297bf5['classList']['add']('border-red-500');});return;}registerButton['disabled']=!![],registerButton['textContent']=_0x3c1785(0x1a0),otpInputs[_0x3c1785(0x1a3)](_0x30aa89=>{const _0x420d9f=_0x3c1785;_0x30aa89[_0x420d9f(0x18f)]=!![],_0x30aa89['classList']['add'](_0x420d9f(0x170));}),messageDiv[_0x3c1785(0x1a1)]='',loadingOverlay[_0x3c1785(0x192)][_0x3c1785(0x159)](_0x3c1785(0x191));let _0x3cd983=0x3;spinnerCountdown[_0x3c1785(0x1a1)]=''+_0x3cd983,countdownInterval&&clearInterval(countdownInterval),countdownInterval=setInterval(()=>{const _0x263660=_0x3c1785;_0x3cd983--,spinnerCountdown[_0x263660(0x1a1)]=''+_0x3cd983,_0x3cd983<=0x0&&clearInterval(countdownInterval);},0x3e8),setTimeout(()=>{performFirebaseCheck(_0x27bfd3);},0xbb8);}async function updateRegistration(_0x1460da){const _0x27213e=_0xa5397d,_0x1c3c7e=serverTimestamp();try{const _0x563305=doc(db,_0x27213e(0x15c),_0x1460da);return await updateDoc(_0x563305,{'DateLogin':_0x1c3c7e}),console[_0x27213e(0x17a)](_0x27213e(0x1a8)),_0x1c3c7e;}catch(_0x213882){console[_0x27213e(0x186)](_0x27213e(0x15e),_0x213882);throw _0x213882;}}async function processRewardTransaction(_0x21cc6d){const _0x3dd395=_0xa5397d,_0x167b0d=getRewardConfigRef(),_0xb25bcb=doc(db,'data_employee',_0x21cc6d);let _0x51f81f=![];try{return await runTransaction(db,async _0x3639db=>{const _0x10c7da=_0x5d8c,_0xcd7f48=await _0x3639db[_0x10c7da(0x1ac)](_0x167b0d);if(!_0xcd7f48[_0x10c7da(0x1ce)]())throw new Error(_0x10c7da(0x167));const _0x185ec9=_0xcd7f48[_0x10c7da(0x1bd)]();let _0x584f8c=_0x185ec9[_0x10c7da(0x1c6)]||0x0;_0x584f8c>0x0?(_0x584f8c-=0x1,_0x3639db[_0x10c7da(0x185)](_0x167b0d,{'number_extra':_0x584f8c}),_0x3639db[_0x10c7da(0x185)](_0xb25bcb,{'RewardGranted':!![],'DateReward':serverTimestamp(),'DateConfirm':null}),_0x51f81f=!![]):_0x3639db[_0x10c7da(0x17c)](_0xb25bcb,{'RewardGranted':![]},{'merge':!![]});}),_0x51f81f;}catch(_0x1ad837){return console[_0x3dd395(0x186)](_0x3dd395(0x189),_0x1ad837),![];}}function displayEmployeeInfo(_0x2464b6,_0x568975,_0x975575){const _0xa8115e=_0xa5397d;infoFullName[_0xa8115e(0x1a1)]=(_0x2464b6[_0xa8115e(0x1b7)]||_0x2464b6['FullName_th']||'')+'\x20('+_0x568975+')',infoChief[_0xa8115e(0x1a1)]=''+(_0x2464b6['Chief']||_0xa8115e(0x1a2));const _0x202412=formatThaiTimestamp(_0x2464b6[_0xa8115e(0x18c)]);infoDateLogin[_0xa8115e(0x1a1)]=_0xa8115e(0x178)+_0x202412,infoDateLogin[_0xa8115e(0x192)][_0xa8115e(0x159)]('hidden'),rewardStatusMessage['classList'][_0xa8115e(0x159)]('hidden'),rewardStatusMessage[_0xa8115e(0x18b)]='',rewardStatusMessage['classList'][_0xa8115e(0x159)](_0xa8115e(0x157),_0xa8115e(0x1bb),_0xa8115e(0x182)),rewardStatusMessage['classList']['add'](_0xa8115e(0x1d3));if(_0x2464b6[_0xa8115e(0x199)]===!![]){if(openRewardStatus!==0x0){const _0x7bb691=_0x2464b6[_0xa8115e(0x195)],_0x270ecd=!!_0x7bb691,_0x20ab84=_0x270ecd?'ยืนยันการรับรางวัลแล้ว':_0xa8115e(0x1d4);rewardStatusMessage[_0xa8115e(0x18b)]=_0xa8115e(0x180)+(_0x270ecd?'bg-gray-500\x20cursor-not-allowed':'bg-green-600\x20hover:bg-green-700\x20focus:ring-green-500')+_0xa8115e(0x1d0)+(_0x270ecd?_0xa8115e(0x18f):'')+'>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+_0x20ab84+_0xa8115e(0x1af)+(_0x270ecd?'ยืนยันการรับรางวัลเมื่อ:\x20'+formatThaiTimestamp(_0x7bb691):'ให้เจ้าหน้าที่เป็นผู้กดปุ่มยืนยันการรับรางวัล')+_0xa8115e(0x19a),!_0x270ecd&&document[_0xa8115e(0x197)](_0xa8115e(0x1b8))['addEventListener'](_0xa8115e(0x163),handleRewardConfirm),rewardStatusMessage[_0xa8115e(0x192)][_0xa8115e(0x159)](_0xa8115e(0x1d3));}else rewardStatusMessage['innerHTML']=_0xa8115e(0x165),rewardStatusMessage['classList'][_0xa8115e(0x159)](_0xa8115e(0x1d3));}else _0x2464b6[_0xa8115e(0x199)]===![]?(rewardStatusMessage[_0xa8115e(0x192)][_0xa8115e(0x174)](_0xa8115e(0x191)),infoDateLogin[_0xa8115e(0x192)]['add'](_0xa8115e(0x191))):(rewardStatusMessage[_0xa8115e(0x192)]['add'](_0xa8115e(0x191)),infoDateLogin[_0xa8115e(0x192)]['remove'](_0xa8115e(0x191)));registrationForm['classList'][_0xa8115e(0x174)](_0xa8115e(0x191)),employeeInfoDisplay[_0xa8115e(0x192)]['remove']('hidden'),registerButton[_0xa8115e(0x1a1)]=_0x2464b6[_0xa8115e(0x18c)]?_0xa8115e(0x160):_0xa8115e(0x161);}async function performFirebaseCheck(_0x476c43){const _0x3e8f9e=_0xa5397d;loadingOverlay[_0x3e8f9e(0x192)][_0x3e8f9e(0x174)](_0x3e8f9e(0x191));countdownInterval&&clearInterval(countdownInterval);try{let _0x9adcc5=await getCrsgDoc(_0x476c43);if(!_0x9adcc5){errorLightbox[_0x3e8f9e(0x192)]['remove'](_0x3e8f9e(0x191));return;}let _0x2a1620=_0x9adcc5[_0x3e8f9e(0x1bd)];const _0x6aebca=_0x9adcc5['id'];currentEmployeeDocId=_0x6aebca;const _0x44148e=!!_0x2a1620[_0x3e8f9e(0x18c)];if(_0x44148e){displayEmployeeInfo(_0x2a1620,_0x476c43,![]);return;}const _0x353e34=await processRewardTransaction(_0x6aebca);await updateRegistration(_0x6aebca),_0x9adcc5=await getCrsgDoc(_0x476c43),_0x9adcc5&&(_0x2a1620=_0x9adcc5[_0x3e8f9e(0x1bd)]),displayEmployeeInfo(_0x2a1620,_0x476c43,!![]);}catch(_0x575380){console[_0x3e8f9e(0x186)]('Error\x20during\x20registration\x20process:\x20',_0x575380),_0x575380[_0x3e8f9e(0x184)]['includes']('permissions')?(messageDiv['innerHTML']=_0x3e8f9e(0x1c8),messageDiv['className']=_0x3e8f9e(0x16e)):(messageDiv['textContent']='เกิดข้อผิดพลาด:\x20'+_0x575380['message'],messageDiv[_0x3e8f9e(0x152)]=_0x3e8f9e(0x153)),registerButton['disabled']=![],registerButton[_0x3e8f9e(0x1a1)]=_0x3e8f9e(0x1a6),teamDisplay[_0x3e8f9e(0x192)][_0x3e8f9e(0x174)](_0x3e8f9e(0x191)),otpInputs[_0x3e8f9e(0x1a3)](_0x5486b0=>{const _0x38acb5=_0x3e8f9e;_0x5486b0['disabled']=![],_0x5486b0[_0x38acb5(0x192)]['remove']('bg-gray-100');}),employeeInfoDisplay['classList'][_0x3e8f9e(0x174)]('hidden'),eventDate[_0x3e8f9e(0x192)][_0x3e8f9e(0x159)](_0x3e8f9e(0x191)),eventImageContainer[_0x3e8f9e(0x192)][_0x3e8f9e(0x159)]('hidden'),registrationForm[_0x3e8f9e(0x192)][_0x3e8f9e(0x159)]('hidden');}finally{fetchRewardConfig();}}async function getCrsgDoc(_0x3659a9){const _0xd49e45=_0xa5397d,_0x5a4789='data_employee',_0x1bb38c=query(collection(db,_0x5a4789),or(where(_0xd49e45(0x1c3),'==',_0x3659a9),where(_0xd49e45(0x1be),'==',_0x3659a9)),limit(0x1)),_0x4cc8fa=await getDocs(_0x1bb38c);if(_0x4cc8fa[_0xd49e45(0x17b)])return null;const _0x3d00ce=_0x4cc8fa[_0xd49e45(0x176)][0x0];return{'id':_0x3d00ce['id'],'data':_0x3d00ce['data']()};}
        
    </script>
</body>
</html>