<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ttb registration</title>
    <!-- โหลด Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        /* (เพิ่ม) สไตล์สำหรับช่อง OTP Input */
        .otp-input {
            transition: all 0.15s ease-in-out;
        }
        .otp-input:disabled {
            background-color: #f3f4f6; /* bg-gray-100 */
        }
        .img {
              margin: 15px auto !important;
        }
    </style>
</head>
<!-- (แก้ไข) ปรับ margin-top (pt-8 = 2rem) -->
<body class="bg-white flex flex-col items-center justify-center min-h-screen pt-8 pb-10" style="background-color: #dee1e1;">

    <!-- กล่องลงทะเบียน -->
    <!-- (แก้ไข) เปลี่ยน bg-gray-50 เป็น bg-white และเพิ่ม 'relative' สำหรับ Overlay -->
    <div id="registrationFormContainer" class="w-[95%] max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md transition-colors duration-300 relative">
        <h1 class="text-2xl font-bold text-center text-gray-900">ttb registration</h1>
        <!-- *** แก้ไข: เพิ่ม id="eventDate" *** -->
        <p id="eventDate" class="text-sm font-medium text-gray-700 text-center" style="margin-top: 2px;">วันที่ 17 พฤศจิกายน 2568</p>

        <!-- *** แก้ไข: เพิ่ม id="eventImageContainer" *** -->
        <!-- (แก้ไข) เปลี่ยน mt-6 เป็น my-4 (margin top/bottom 16px) -->
        <div id="eventImageContainer" class="my-4 w-[70%] mx-auto">
            <img src="./images/refer_friend.jpg">
        </div>
              
        <!-- *** (แก้ไข) ปรับปรุงโครงสร้างการแสดงข้อมูลพนักงาน *** -->
        <div id="employeeInfoDisplay" class="hidden text-center space-y-2 py-4">
            <!-- 1. ชื่อ-นามสกุล (Name) (รหัสพนักงาน) (EmpID) -->
            <p id="infoFullName" class="text-lg font-bold text-gray-900"></p> 
            
            <!-- (แก้ไข) 2. (Chief) แทนที่ EmpZoneRH -->
            <p id="infoChief" class="text-base text-gray-700"></p>
            
            <!-- 3. กล่องลงทะเบียนสำเร็จ + DateLogin (NEW STRUCTURE) -->
            <div id="registrationSuccessBox" class="mt-4 p-3 bg-green-100 border border-green-300 rounded-lg shadow-sm">
                <p class="text-lg font-extrabold text-green-700">ลงทะเบียนสำเร็จ</p> 
                <!-- (แก้ไข) ย้าย DateLogin เข้ามาในกล่องสำเร็จ (สีเทาเข้ม, ตัวเล็ก) -->
                <p id="infoDateLogin" class="text-xs font-medium text-gray-600 mt-1"></p> 
            </div>
            
            <!-- (เพิ่ม) 4. แสดงสถานะรางวัล / กล่องรางวัลพิเศษ (จะถูกแทนที่ด้วยปุ่มยืนยันหากมีการตั้งค่า) -->
            <p id="rewardStatusMessage" class="text-sm font-semibold text-gray-700 pt-2"></p>
        </div>

        <!-- ฟอร์มลงทะเบียน -->
        <form id="registrationForm" class="space-y-4">
            
            <!-- (แก้ไข) เปลี่ยนเป็นช่อง OTP 5 ช่อง -->
            <div>
                <!-- (ลบ) ลบ Label "รหัสพนักงาน" -->
                <div id="otpContainer" class="flex justify-center gap-1 sm:gap-2">
                    <!-- (แก้ไข) เพิ่มขนาดตัวอักษรเป็น text-2xl -->
                    <input type="tel" maxlength="1" class="otp-input w-9 h-11 sm:w-10 sm:h-12 text-center text-2xl font-semibold border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    <input type="tel" maxlength="1" class="otp-input w-9 h-11 sm:w-10 sm:h-12 text-center text-2xl font-semibold border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    <input type="tel" maxlength="1" class="otp-input w-9 h-11 sm:w-10 sm:h-12 text-center text-2xl font-semibold border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    <input type="tel" maxlength="1" class="otp-input w-9 h-11 sm:w-10 sm:h-12 text-center text-2xl font-semibold border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    <input type="tel" maxlength="1" class="otp-input w-9 h-11 sm:w-10 sm:h-12 text-center text-2xl font-semibold border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </div>
                <!-- (เพิ่ม) Helper text และเว้นช่องว่างด้านล่าง (mb-4) -->
                <div style="height:5px;"></div>
                <p class="text-xs text-gray-500 text-center mt-2 mb-4">ใส่รหัสพนักงานของคุณให้ถูกต้องก่อนกด ลงทะเบียน</p>
            </div>
            
            <!-- (ลบ) ช่องชื่อเล่น -->
            
            <button type="button" id="registerButton"
                    class="w-full px-4 py-2 font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out disabled:bg-gray-400"
                    disabled> <!-- (เพิ่ม) disabled ปุ่มไว้ตอนเริ่ม -->
                ลงทะเบียน
            </button>
        </form>
        
        <!-- NEW: Reward Count Display -->
        <div id="rewardCountDisplay" class="text-center text-sm mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-md">
            <p class="text-gray-700">
                รางวัลคงเหลือ: <span id="rewardCountValue" class="font-bold text-red-600">กำลังโหลด...</span> รายการ
            </p>
        </div>

        <!-- พื้นที่แสดงข้อความ (สำหรับข้อผิดพลาดหลัก) --><div id="message" class="text-center text-sm"></div>

        <!-- (ลบ) ลบส่วนแสดงข้อความลงทะเบียนสำเร็จ (teamDisplay) -->
        <div id="teamDisplay" class="hidden text-center border-t pt-4 mt-4">
            <h2 id="teamNameDisplay" class="text-8xl font-bold text-[#0056ff]"></h2> 
            <p class="text-sm font-medium text-gray-700 mt-1">ทีมของคุณ</p>
            
            <p id="registrationStatusMessage" class="text-sm mt-4"></p>
            <p id="registrationTimestamp" class="text-xs text-gray-500"></p>
        </div>

        <!-- (เพิ่ม) Loading Overlay สำหรับ Spinner -->
        <div id="loadingOverlay" class="hidden absolute inset-0 bg-white bg-opacity-80 flex flex-col items-center justify-center space-y-4 rounded-lg z-20">
            <svg class="animate-spin h-12 w-12 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <!-- (แก้ไข) ปรับเลข Countdown เริ่มต้นเป็น 3 -->
            <p class="text-lg font-medium text-gray-700">กำลังตรวจสอบข้อมูล... <span id="spinnerCountdown">3</span></p>
        </div>
    </div>

    <!-- (เพิ่ม) Lightbox (Modal) สำหรับแจ้งเตือน Error -->
    <div id="errorLightbox" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
            <!-- (แก้ไข) ปรับขนาด Font จาก text-base เป็น text-sm -->
            <p id="errorLightboxMessage" class="text-sm text-gray-800 mb-6">ไม่พบรหัสพนักงานนี้ในระบบ<br>กรุณากรอกรหัสพนักงานใหม่อีกครั้ง</p>
            <button id="closeLightboxButton" class="w-full px-4 py-2 font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                ปิด
            </button>
        </div>
    </div>

    <!-- Firebase SDK และการเชื่อมต่อ --><script type="module">
        // นำเข้า Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // (แก้ไข) เพิ่ม getDoc และ runTransaction
        import { getFirestore, collection, getDocs, query, where, serverTimestamp, setLogLevel, limit, doc, updateDoc, or, getDoc, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"; 

        // --- *** ข้อสำคัญ: สำหรับแก้ไข "Missing or insufficient permissions." *** ---
        // (ส่วนนี้เหมือนเดิม)
        // ... (Security Rules comment block) ...
        // --- *************************************************************** ---


        // --- *** 1. ใส่ Firebase Config ของคุณที่นี่ *** ---
const _0x55730e=_0x2e40;(function(_0x345f17,_0x1bdd21){const _0x10a767=_0x2e40,_0x241919=_0x345f17();while(!![]){try{const _0x5740eb=-parseInt(_0x10a767(0x191))/0x1*(-parseInt(_0x10a767(0x1ae))/0x2)+parseInt(_0x10a767(0x185))/0x3+parseInt(_0x10a767(0x1b2))/0x4+parseInt(_0x10a767(0x17f))/0x5+parseInt(_0x10a767(0x18d))/0x6*(-parseInt(_0x10a767(0x166))/0x7)+-parseInt(_0x10a767(0x1b8))/0x8+-parseInt(_0x10a767(0x193))/0x9*(-parseInt(_0x10a767(0x18e))/0xa);if(_0x5740eb===_0x1bdd21)break;else _0x241919['push'](_0x241919['shift']());}catch(_0x24ddbc){_0x241919['push'](_0x241919['shift']());}}}(_0x5ca2,0xc033a));const firebaseConfig={'apiKey':_0x55730e(0x1b0),'authDomain':_0x55730e(0x15f),'databaseURL':_0x55730e(0x176),'projectId':'ttb-register','storageBucket':_0x55730e(0x184),'messagingSenderId':_0x55730e(0x164),'appId':_0x55730e(0x136),'measurementId':_0x55730e(0x188)},configCollectionName=_0x55730e(0x1a9);let db,auth,currentEmployeeDocId=null,openRewardStatus=0x0;const registrationFormContainer=document[_0x55730e(0x178)](_0x55730e(0x19f)),otpContainer=document['getElementById']('otpContainer'),otpInputs=otpContainer?Array[_0x55730e(0x177)](otpContainer[_0x55730e(0x158)](_0x55730e(0x148))):[],registerButton=document[_0x55730e(0x178)](_0x55730e(0x179)),messageDiv=document[_0x55730e(0x178)](_0x55730e(0x195)),teamDisplay=document[_0x55730e(0x178)](_0x55730e(0x132)),teamNameDisplay=document[_0x55730e(0x178)](_0x55730e(0x172)),regStatusMsg=document[_0x55730e(0x178)](_0x55730e(0x1a0)),regTimestamp=document[_0x55730e(0x178)]('registrationTimestamp'),eventDate=document[_0x55730e(0x178)](_0x55730e(0x162)),eventImageContainer=document[_0x55730e(0x178)](_0x55730e(0x192)),registrationForm=document[_0x55730e(0x178)](_0x55730e(0x19e)),employeeInfoDisplay=document[_0x55730e(0x178)](_0x55730e(0x168)),infoFullName=document['getElementById'](_0x55730e(0x173)),infoChief=document[_0x55730e(0x178)]('infoChief'),registrationSuccessBox=document['getElementById'](_0x55730e(0x18a)),infoDateLogin=document[_0x55730e(0x178)](_0x55730e(0x1b6)),rewardStatusMessage=document[_0x55730e(0x178)](_0x55730e(0x13c)),rewardCountDisplay=document[_0x55730e(0x178)](_0x55730e(0x15d)),rewardCountValue=document[_0x55730e(0x178)]('rewardCountValue'),loadingOverlay=document[_0x55730e(0x178)](_0x55730e(0x199)),spinnerCountdown=document[_0x55730e(0x178)](_0x55730e(0x16f)),errorLightbox=document[_0x55730e(0x178)]('errorLightbox'),errorLightboxMessage=document[_0x55730e(0x178)](_0x55730e(0x155)),closeLightboxButton=document[_0x55730e(0x178)]('closeLightboxButton');let countdownInterval;function alertLightbox(_0x28c409){const _0x41717f=_0x55730e;errorLightboxMessage[_0x41717f(0x198)]=_0x28c409,errorLightbox[_0x41717f(0x161)][_0x41717f(0x142)](_0x41717f(0x181));}function checkOtpCompleteness(){const _0x5d1ca0=_0x55730e;let _0x5206a7=!![];otpInputs['forEach'](_0x5518d2=>{const _0x4d085a=_0x2e40;_0x5518d2[_0x4d085a(0x160)]['trim']()[_0x4d085a(0x14e)]===0x0&&(_0x5206a7=![]);}),registerButton[_0x5d1ca0(0x134)]=!_0x5206a7;}function getRewardConfigRef(){const _0x226ec9=_0x55730e;return doc(db,configCollectionName,_0x226ec9(0x187));}async function fetchRewardConfig(){const _0x2d87c2=_0x55730e;if(!db){console[_0x2d87c2(0x194)](_0x2d87c2(0x1ac)),rewardCountValue['textContent']=_0x2d87c2(0x16e);return;}try{const _0x7e5e50=getRewardConfigRef(),_0x335f17=await getDoc(_0x7e5e50);if(_0x335f17[_0x2d87c2(0x141)]()){const _0x47229f=_0x335f17['data'](),_0x39b65b=_0x47229f['number_extra'];openRewardStatus=_0x47229f[_0x2d87c2(0x1ad)]||0x0,typeof _0x39b65b===_0x2d87c2(0x182)?_0x39b65b===0x0?rewardCountDisplay[_0x2d87c2(0x161)][_0x2d87c2(0x130)]('hidden'):(rewardCountDisplay['classList'][_0x2d87c2(0x142)]('hidden'),rewardCountValue[_0x2d87c2(0x1a8)]=_0x39b65b[_0x2d87c2(0x17d)]('th-TH')):(rewardCountDisplay[_0x2d87c2(0x161)][_0x2d87c2(0x142)](_0x2d87c2(0x181)),rewardCountValue[_0x2d87c2(0x1a8)]=_0x2d87c2(0x157),console[_0x2d87c2(0x194)](_0x2d87c2(0x167)));}else rewardCountDisplay[_0x2d87c2(0x161)][_0x2d87c2(0x130)](_0x2d87c2(0x181)),rewardCountValue[_0x2d87c2(0x1a8)]=_0x2d87c2(0x14d),console[_0x2d87c2(0x194)](_0x2d87c2(0x13b));}catch(_0x566be5){console[_0x2d87c2(0x186)](_0x2d87c2(0x19a),_0x566be5),rewardCountDisplay[_0x2d87c2(0x161)][_0x2d87c2(0x142)](_0x2d87c2(0x181)),rewardCountValue[_0x2d87c2(0x1a8)]=_0x2d87c2(0x16e);}}try{const app=initializeApp(firebaseConfig);db=getFirestore(app),auth=getAuth(app),setLogLevel(_0x55730e(0x135)),signInAnonymously(auth)[_0x55730e(0x163)](()=>{const _0xab563d=_0x55730e;console[_0xab563d(0x1b7)](_0xab563d(0x131)),fetchRewardConfig();}),otpInputs[_0x55730e(0x14e)]>0x0&&otpInputs[0x0][_0x55730e(0x139)](),closeLightboxButton[_0x55730e(0x156)]('click',()=>{const _0x1fc079=_0x55730e;errorLightbox[_0x1fc079(0x161)]['add'](_0x1fc079(0x181)),registerButton['disabled']=![],registerButton[_0x1fc079(0x1a8)]=_0x1fc079(0x16d),otpInputs[_0x1fc079(0x14f)](_0x2d9ff8=>{const _0xb37be2=_0x1fc079;_0x2d9ff8[_0xb37be2(0x134)]=![],_0x2d9ff8[_0xb37be2(0x161)][_0xb37be2(0x142)]('bg-gray-100'),_0x2d9ff8['classList']['remove'](_0xb37be2(0x13a)),_0x2d9ff8['value']='';}),otpInputs[_0x1fc079(0x14e)]>0x0&&otpInputs[0x0][_0x1fc079(0x139)](),checkOtpCompleteness();});}catch(_0x1858a2){console[_0x55730e(0x186)](_0x55730e(0x19d),_0x1858a2),document['getElementById'](_0x55730e(0x195))[_0x55730e(0x1a8)]='เกิดข้อผิดพลาดในการเชื่อมต่อฐานข้อมูล:\x20'+_0x1858a2[_0x55730e(0x195)];}registerButton[_0x55730e(0x156)](_0x55730e(0x144),handleRegisterCheck);otpContainer&&otpInputs[_0x55730e(0x14f)]((_0x14bfb7,_0x4b5798)=>{const _0x7fbb93=_0x55730e;_0x14bfb7[_0x7fbb93(0x156)](_0x7fbb93(0x1b5),_0x52e7f0=>{const _0x33bc5a=_0x7fbb93;_0x14bfb7['value']=_0x14bfb7[_0x33bc5a(0x160)][_0x33bc5a(0x17b)](/[^0-9]/g,'');const _0x4689d=_0x14bfb7[_0x33bc5a(0x160)];if(_0x4689d[_0x33bc5a(0x14e)]===0x1)_0x14bfb7[_0x33bc5a(0x161)]['add'](_0x33bc5a(0x13a)),_0x4b5798<otpInputs[_0x33bc5a(0x14e)]-0x1&&otpInputs[_0x4b5798+0x1][_0x33bc5a(0x139)]();else _0x4689d[_0x33bc5a(0x14e)]===0x0&&_0x14bfb7['classList'][_0x33bc5a(0x142)](_0x33bc5a(0x13a));checkOtpCompleteness();}),_0x14bfb7[_0x7fbb93(0x156)](_0x7fbb93(0x143),_0x5ceead=>{const _0x54cfb7=_0x7fbb93;_0x5ceead['key']===_0x54cfb7(0x1af)&&_0x14bfb7['value']===''&&_0x4b5798>0x0&&(_0x5ceead['preventDefault'](),otpInputs[_0x4b5798-0x1]['focus'](),otpInputs[_0x4b5798-0x1][_0x54cfb7(0x1a7)]());}),_0x14bfb7['addEventListener']('paste',_0x1bbb07=>{const _0x47bcfa=_0x7fbb93;_0x1bbb07['preventDefault']();const _0x19f097=_0x1bbb07[_0x47bcfa(0x15a)][_0x47bcfa(0x1a6)]('text')[_0x47bcfa(0x137)]()[_0x47bcfa(0x17b)](/[^0-9]/g,'');if(_0x19f097[_0x47bcfa(0x14e)]===otpInputs['length'])otpInputs['forEach']((_0x4381f5,_0x2d3465)=>{const _0x39ebe6=_0x47bcfa;_0x4381f5[_0x39ebe6(0x160)]=_0x19f097[_0x2d3465]||'',_0x4381f5[_0x39ebe6(0x160)]?_0x4381f5[_0x39ebe6(0x161)][_0x39ebe6(0x130)](_0x39ebe6(0x13a)):_0x4381f5['classList'][_0x39ebe6(0x142)]('bg-blue-200');}),otpInputs[otpInputs[_0x47bcfa(0x14e)]-0x1]['focus']();else{if(_0x19f097[_0x47bcfa(0x14e)]>0x0){let _0x261eae=_0x4b5798;for(let _0x5e9bf3=0x0;_0x5e9bf3<_0x19f097[_0x47bcfa(0x14e)]&&_0x261eae<otpInputs[_0x47bcfa(0x14e)];_0x5e9bf3++){otpInputs[_0x261eae][_0x47bcfa(0x160)]=_0x19f097[_0x5e9bf3],otpInputs[_0x261eae][_0x47bcfa(0x161)][_0x47bcfa(0x130)](_0x47bcfa(0x13a)),_0x261eae<otpInputs[_0x47bcfa(0x14e)]-0x1&&otpInputs[_0x261eae+0x1]['focus'](),_0x261eae++;}}}setTimeout(checkOtpCompleteness,0x0);}),_0x14bfb7[_0x7fbb93(0x156)]('focus',_0x9f4ab9=>{const _0x4e503f=_0x7fbb93;_0x9f4ab9[_0x4e503f(0x175)][_0x4e503f(0x1a7)]();});});function formatThaiTimestamp(_0x45afbf){const _0x293edc=_0x55730e,_0x388d74=_0x45afbf&&typeof _0x45afbf[_0x293edc(0x13d)]==='function'?_0x45afbf['toDate']():_0x45afbf;if(_0x388d74 instanceof Date&&!isNaN(_0x388d74))return _0x388d74[_0x293edc(0x17d)](_0x293edc(0x14b),{'dateStyle':_0x293edc(0x180),'timeStyle':'medium'});return'ไม่มีข้อมูล';}async function handleRewardConfirm(){const _0x5bbcd0=_0x55730e,_0xa086b=currentEmployeeDocId;if(!_0xa086b){console[_0x5bbcd0(0x186)](_0x5bbcd0(0x1aa)),alertLightbox(_0x5bbcd0(0x1a1));return;}const _0xd1cbd3=document[_0x5bbcd0(0x178)](_0x5bbcd0(0x138));_0xd1cbd3&&(_0xd1cbd3[_0x5bbcd0(0x134)]=!![],_0xd1cbd3[_0x5bbcd0(0x1a8)]=_0x5bbcd0(0x1b4),_0xd1cbd3[_0x5bbcd0(0x161)]['remove'](_0x5bbcd0(0x17c),_0x5bbcd0(0x19c)),_0xd1cbd3[_0x5bbcd0(0x161)][_0x5bbcd0(0x130)](_0x5bbcd0(0x189)));try{const _0x20891b=doc(db,_0x5bbcd0(0x190),_0xa086b),_0x7f0d26=getRewardConfigRef();await runTransaction(db,async _0x14e152=>{const _0xb9411c=_0x5bbcd0,_0x4b25b7=await _0x14e152[_0xb9411c(0x1b1)](_0x7f0d26);if(!_0x4b25b7['exists']())throw new Error(_0xb9411c(0x197));const _0x212761=_0x4b25b7[_0xb9411c(0x17a)](),_0x39bfac=_0x212761[_0xb9411c(0x1a3)]||0x0;_0x14e152[_0xb9411c(0x1a5)](_0x20891b,{'DateConfirm':serverTimestamp()}),_0x14e152['update'](_0x7f0d26,{'number_getreward':_0x39bfac+0x1});}),console[_0x5bbcd0(0x1b7)](_0x5bbcd0(0x183));const _0x129678=infoFullName[_0x5bbcd0(0x1a8)][_0x5bbcd0(0x18c)](/\(([^)]+)\)/)?.[0x1];if(_0x129678){let _0x1f445a=await getCrsgDoc(_0x129678);_0x1f445a&&displayEmployeeInfo(_0x1f445a[_0x5bbcd0(0x17a)],_0x129678,![]);}}catch(_0x5991dc){console[_0x5bbcd0(0x186)](_0x5bbcd0(0x154),_0x5991dc),alertLightbox(_0x5bbcd0(0x15c)+_0x5991dc[_0x5bbcd0(0x195)]),_0xd1cbd3&&(_0xd1cbd3[_0x5bbcd0(0x134)]=![],_0xd1cbd3[_0x5bbcd0(0x1a8)]='เกิดข้อผิดพลาด\x20(ลองอีกครั้ง)',_0xd1cbd3['classList']['remove'](_0x5bbcd0(0x189)),_0xd1cbd3[_0x5bbcd0(0x161)]['add']('bg-red-600'));}finally{fetchRewardConfig();}}function handleRegisterCheck(){const _0x36dff7=_0x55730e;let _0xe9a8e0='';otpInputs[_0x36dff7(0x14f)](_0x41f820=>{const _0x2370ba=_0x36dff7;_0xe9a8e0+=_0x41f820['value'][_0x2370ba(0x137)]();}),otpInputs[_0x36dff7(0x14f)](_0x470231=>_0x470231[_0x36dff7(0x161)][_0x36dff7(0x142)](_0x36dff7(0x152)));if(_0xe9a8e0[_0x36dff7(0x14e)]<0x5){messageDiv[_0x36dff7(0x1a8)]=_0x36dff7(0x159),messageDiv[_0x36dff7(0x140)]='text-center\x20text-sm\x20text-red-600',otpInputs[_0x36dff7(0x14f)](_0x48d8a2=>{const _0x409f66=_0x36dff7;!_0x48d8a2[_0x409f66(0x160)]&&_0x48d8a2[_0x409f66(0x161)][_0x409f66(0x130)](_0x409f66(0x152));});return;}registerButton[_0x36dff7(0x134)]=!![],registerButton[_0x36dff7(0x1a8)]=_0x36dff7(0x150),otpInputs[_0x36dff7(0x14f)](_0x29fe4c=>{const _0x36b270=_0x36dff7;_0x29fe4c[_0x36b270(0x134)]=!![],_0x29fe4c[_0x36b270(0x161)][_0x36b270(0x130)]('bg-gray-100');}),messageDiv[_0x36dff7(0x1a8)]='',loadingOverlay[_0x36dff7(0x161)]['remove'](_0x36dff7(0x181));let _0x1b08d2=0x3;spinnerCountdown[_0x36dff7(0x1a8)]=''+_0x1b08d2,countdownInterval&&clearInterval(countdownInterval),countdownInterval=setInterval(()=>{const _0x12f041=_0x36dff7;_0x1b08d2--,spinnerCountdown[_0x12f041(0x1a8)]=''+_0x1b08d2,_0x1b08d2<=0x0&&clearInterval(countdownInterval);},0x3e8),setTimeout(()=>{performFirebaseCheck(_0xe9a8e0);},0xbb8);}async function updateRegistration(_0x567f4d){const _0x23fb6e=_0x55730e,_0x22cbc2=serverTimestamp();try{const _0x34cdb5=doc(db,_0x23fb6e(0x190),_0x567f4d);return await updateDoc(_0x34cdb5,{'DateLogin':_0x22cbc2}),console[_0x23fb6e(0x1b7)](_0x23fb6e(0x17e)),_0x22cbc2;}catch(_0x6f279f){console['error']('Error\x20logging\x20registration:\x20',_0x6f279f);throw _0x6f279f;}}function _0x2e40(_0x404e4c,_0x1140be){const _0x5ca251=_0x5ca2();return _0x2e40=function(_0x2e401b,_0x182c18){_0x2e401b=_0x2e401b-0x130;let _0x3ee41c=_0x5ca251[_0x2e401b];return _0x3ee41c;},_0x2e40(_0x404e4c,_0x1140be);}async function processRewardTransaction(_0x55874e){const _0x4cf19f=_0x55730e,_0xf22d67=getRewardConfigRef(),_0x320457=doc(db,_0x4cf19f(0x190),_0x55874e);let _0x101214=![];try{return await runTransaction(db,async _0x74b52b=>{const _0x4f4b4c=_0x4cf19f,_0x1e3294=await _0x74b52b['get'](_0xf22d67);if(!_0x1e3294[_0x4f4b4c(0x141)]())throw new Error(_0x4f4b4c(0x170));const _0x1615dd=_0x1e3294['data']();let _0x10b169=_0x1615dd[_0x4f4b4c(0x1a4)]||0x0;_0x10b169>0x0?(_0x10b169-=0x1,_0x74b52b[_0x4f4b4c(0x1a5)](_0xf22d67,{'number_extra':_0x10b169}),_0x74b52b[_0x4f4b4c(0x1a5)](_0x320457,{'RewardGranted':!![],'DateReward':serverTimestamp(),'DateConfirm':null}),_0x101214=!![]):_0x74b52b[_0x4f4b4c(0x165)](_0x320457,{'RewardGranted':![]},{'merge':!![]});}),_0x101214;}catch(_0x323f27){return console['error'](_0x4cf19f(0x154),_0x323f27),![];}}function _0x5ca2(){const _0x186422=['Reward\x20configuration\x20document\x20not\x20found.\x20Cannot\x20increment\x20reward\x20counter.','innerHTML','loadingOverlay','Error\x20fetching\x20reward\x20config:','RewardGranted','hover:bg-green-700','Firebase\x20initialization\x20failed:','registrationForm','registrationFormContainer','registrationStatusMessage','ข้อผิดพลาด:\x20ไม่พบ\x20ID\x20พนักงาน\x20กรุณาลงทะเบียนใหม่','pt-2','number_getreward','number_extra','update','getData','select','textContent','data_reward','Employee\x20document\x20ID\x20is\x20missing\x20for\x20confirmation.','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22mt-4\x20p-3\x20bg-indigo-100\x20border\x20border-indigo-300\x20rounded-lg\x20shadow-sm\x20text-gray-800\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20class=\x22text-lg\x20font-extrabold\x20text-indigo-700\x22>คุณได้รับรางวัลพิเศษ</p>\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<!--\x20NEW\x20BUTTON\x20-->\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20type=\x22button\x22\x20id=\x22confirmRewardButton\x22\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20class=\x22w-full\x20mt-3\x20px-4\x20py-2\x20font-medium\x20text-white\x20rounded-md\x20transition\x20duration-150\x20ease-in-out\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','[RewardConfig]\x20Firestore\x20not\x20initialized.','open_reward','3194vjQiji','Backspace','AIzaSyAgWMzWcZPzyzoBu5eQzj2y59nKsxTWurQ','get','1190924DSVVXT','empty','กำลังบันทึก...','input','infoDateLogin','log','6930792YdOGmr','add','Signed\x20in\x20anonymously','teamDisplay','FullName_th','disabled','Debug','1:1070273157855:web:5c8120e1df27e233d8676a','trim','confirmRewardButton','focus','bg-blue-200','Reward\x20configuration\x20document\x20(data_reward/main)\x20not\x20found.','rewardStatusMessage','toDate','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22mt-4\x20p-3\x20bg-yellow-100\x20border\x20border-yellow-300\x20rounded-lg\x20shadow-sm\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20class=\x22text-lg\x20font-extrabold\x20text-yellow-800\x22>คุณได้รับรางวัลพิเศษ</p>\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20class=\x22text-sm\x20font-medium\x20text-yellow-700\x20mt-1\x22>รับรางวัลเมื่อจบกิจกรรม</p>\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','ลงทะเบียนสำเร็จ','className','exists','remove','keydown','click','Error\x20during\x20registration\x20process:\x20','ยืนยันการรับรางวัล','EmpID','.otp-input','text-red-600','text-green-600','th-TH','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','ไม่พบข้อมูล','length','forEach','กำลังตรวจสอบ...','ลงทะเบียนซ้ำ','border-red-500','docs','Reward\x20Transaction\x20failed:','errorLightboxMessage','addEventListener','ไม่ระบุ','querySelectorAll','กรุณากรอกรหัสพนักงานให้ครบ\x205\x20หลัก','clipboardData','>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','เกิดข้อผิดพลาดในการบันทึกยืนยัน:\x20','rewardCountDisplay','permissions','ttb-register.firebaseapp.com','value','classList','eventDate','then','1070273157855','set','14476xWCwdW','Field\x20\x27number_extra\x27\x20is\x20missing\x20or\x20not\x20a\x20number\x20in\x20data_reward/main\x20doc.','employeeInfoDisplay','bg-gray-100','เกิดข้อผิดพลาด:\x20','Name','includes','ลงทะเบียน','ข้อผิดพลาด','spinnerCountdown','Reward\x20configuration\x20document\x20not\x20found.\x20Cannot\x20process\x20reward.','text-center\x20text-sm\x20text-red-600','teamNameDisplay','infoFullName','bg-green-600\x20hover:bg-green-700\x20focus:ring-green-500','target','https://ttb-register-default-rtdb.asia-southeast1.firebasedatabase.app','from','getElementById','registerButton','data','replace','bg-green-600','toLocaleString','Registration\x20Logged\x20successfully\x20(DateLogin\x20updated).','1159795vAapbB','long','hidden','number','Reward\x20confirmation\x20(DateConfirm\x20and\x20number_getreward\x20incremented)\x20logged\x20successfully.','ttb-register.firebasestorage.app','1169805ZugoOW','error','main','G-9DJLWJ5LQW','bg-gray-500','registrationSuccessBox','\x22\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','match','2784gaWQAr','950VUFoiR','DateLogin','data_employee','577omiUNa','eventImageContainer','73143jMAyQL','warn','message','ลงทะเบียนเมื่อ:\x20'];_0x5ca2=function(){return _0x186422;};return _0x5ca2();}function displayEmployeeInfo(_0x2cdc43,_0x383833,_0x4cfeb8){const _0x49bb3f=_0x55730e;infoFullName[_0x49bb3f(0x1a8)]=(_0x2cdc43[_0x49bb3f(0x16b)]||_0x2cdc43[_0x49bb3f(0x133)]||'')+'\x20('+_0x383833+')',infoChief[_0x49bb3f(0x1a8)]=''+(_0x2cdc43['Chief']||'N/A');const _0x459789=formatThaiTimestamp(_0x2cdc43[_0x49bb3f(0x18f)]);infoDateLogin[_0x49bb3f(0x1a8)]=_0x49bb3f(0x196)+_0x459789,infoDateLogin[_0x49bb3f(0x161)][_0x49bb3f(0x142)](_0x49bb3f(0x181)),rewardStatusMessage[_0x49bb3f(0x161)][_0x49bb3f(0x142)](_0x49bb3f(0x181)),rewardStatusMessage[_0x49bb3f(0x198)]='',rewardStatusMessage[_0x49bb3f(0x161)][_0x49bb3f(0x142)](_0x49bb3f(0x14a),_0x49bb3f(0x149),'text-gray-600'),rewardStatusMessage[_0x49bb3f(0x161)][_0x49bb3f(0x130)](_0x49bb3f(0x1a2));if(_0x2cdc43[_0x49bb3f(0x19b)]===!![]){if(openRewardStatus!==0x0){const _0x59433b=_0x2cdc43['DateConfirm'],_0x9fd4cc=!!_0x59433b,_0x3e8bbc=_0x9fd4cc?'ยืนยันการรับรางวัลแล้ว':_0x49bb3f(0x146);rewardStatusMessage['innerHTML']=_0x49bb3f(0x1ab)+(_0x9fd4cc?'bg-gray-500\x20cursor-not-allowed':_0x49bb3f(0x174))+_0x49bb3f(0x18b)+(_0x9fd4cc?_0x49bb3f(0x134):'')+_0x49bb3f(0x15b)+_0x3e8bbc+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20class=\x22text-xs\x20text-gray-600\x20mt-2\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+(_0x9fd4cc?'ยืนยันการรับรางวัลเมื่อ:\x20'+formatThaiTimestamp(_0x59433b):'ให้เจ้าหน้าที่เป็นผู้กดปุ่มยืนยันการรับรางวัล')+_0x49bb3f(0x14c),!_0x9fd4cc&&document[_0x49bb3f(0x178)](_0x49bb3f(0x138))['addEventListener'](_0x49bb3f(0x144),handleRewardConfirm),rewardStatusMessage[_0x49bb3f(0x161)][_0x49bb3f(0x142)](_0x49bb3f(0x1a2));}else rewardStatusMessage[_0x49bb3f(0x198)]=_0x49bb3f(0x13e),rewardStatusMessage['classList']['remove'](_0x49bb3f(0x1a2));}else _0x2cdc43[_0x49bb3f(0x19b)]===![]?(rewardStatusMessage[_0x49bb3f(0x161)]['add'](_0x49bb3f(0x181)),infoDateLogin[_0x49bb3f(0x161)]['add']('hidden')):(rewardStatusMessage[_0x49bb3f(0x161)][_0x49bb3f(0x130)](_0x49bb3f(0x181)),infoDateLogin[_0x49bb3f(0x161)][_0x49bb3f(0x142)](_0x49bb3f(0x181)));registrationForm[_0x49bb3f(0x161)][_0x49bb3f(0x130)](_0x49bb3f(0x181)),employeeInfoDisplay[_0x49bb3f(0x161)][_0x49bb3f(0x142)]('hidden'),registerButton[_0x49bb3f(0x1a8)]=_0x2cdc43['DateLogin']?_0x49bb3f(0x151):_0x49bb3f(0x13f);}async function performFirebaseCheck(_0x120159){const _0x46f6c5=_0x55730e;loadingOverlay[_0x46f6c5(0x161)][_0x46f6c5(0x130)](_0x46f6c5(0x181));countdownInterval&&clearInterval(countdownInterval);try{let _0x427df1=await getCrsgDoc(_0x120159);if(!_0x427df1){errorLightbox['classList']['remove']('hidden');return;}let _0x40f573=_0x427df1[_0x46f6c5(0x17a)];const _0x31eaa9=_0x427df1['id'];currentEmployeeDocId=_0x31eaa9;const _0x470b1d=!!_0x40f573['DateLogin'];if(_0x470b1d){displayEmployeeInfo(_0x40f573,_0x120159,![]);return;}const _0x53f243=await processRewardTransaction(_0x31eaa9);await updateRegistration(_0x31eaa9),_0x427df1=await getCrsgDoc(_0x120159),_0x427df1&&(_0x40f573=_0x427df1[_0x46f6c5(0x17a)]),displayEmployeeInfo(_0x40f573,_0x120159,!![]);}catch(_0x18655a){console['error'](_0x46f6c5(0x145),_0x18655a),_0x18655a['message'][_0x46f6c5(0x16c)](_0x46f6c5(0x15e))?(messageDiv['innerHTML']='\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20class=\x22font-bold\x20text-red-700\x22>เกิดข้อผิดพลาด:\x20ไม่มีสิทธิ์\x20(Missing\x20or\x20insufficient\x20permissions)</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20class=\x22mt-2\x20text-sm\x20text-gray-700\x22>ปัญหานี้เกิดจาก\x20Security\x20Rules\x20ใน\x20Firebase\x20ของคุณ</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20class=\x22mt-1\x20text-sm\x20text-gray-700\x22>กรุณาดู\x20<strong\x20class=\x22text-black\x22>\x22ข้อสำคัญ\x22</strong>\x20ในคอมเมนต์\x20(หมายเหตุ)\x20ในไฟล์นี้</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20class=\x22mt-1\x20text-sm\x20text-gray-700\x22>ซึ่งอยู่ที่ประมาณบรรทัดที่\x20113\x20เพื่อดูวิธีแก้ไขครับ</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20',messageDiv[_0x46f6c5(0x140)]='text-center\x20text-sm\x20p-3\x20bg-red-50\x20border\x20border-red-200\x20rounded-md'):(messageDiv[_0x46f6c5(0x1a8)]=_0x46f6c5(0x16a)+_0x18655a[_0x46f6c5(0x195)],messageDiv[_0x46f6c5(0x140)]=_0x46f6c5(0x171)),registerButton[_0x46f6c5(0x134)]=![],registerButton[_0x46f6c5(0x1a8)]=_0x46f6c5(0x16d),teamDisplay[_0x46f6c5(0x161)][_0x46f6c5(0x130)](_0x46f6c5(0x181)),otpInputs['forEach'](_0x17154c=>{const _0x5ea171=_0x46f6c5;_0x17154c[_0x5ea171(0x134)]=![],_0x17154c[_0x5ea171(0x161)][_0x5ea171(0x142)](_0x5ea171(0x169));}),employeeInfoDisplay[_0x46f6c5(0x161)][_0x46f6c5(0x130)](_0x46f6c5(0x181)),eventDate[_0x46f6c5(0x161)][_0x46f6c5(0x142)](_0x46f6c5(0x181)),eventImageContainer[_0x46f6c5(0x161)][_0x46f6c5(0x142)]('hidden'),registrationForm['classList'][_0x46f6c5(0x142)](_0x46f6c5(0x181));}finally{fetchRewardConfig();}}async function getCrsgDoc(_0x562d6b){const _0x4dfa99=_0x55730e,_0x4d4902='data_employee',_0x3af00e=query(collection(db,_0x4d4902),or(where(_0x4dfa99(0x147),'==',_0x562d6b),where('employeeId','==',_0x562d6b)),limit(0x1)),_0x4e75e6=await getDocs(_0x3af00e);if(_0x4e75e6[_0x4dfa99(0x1b3)])return null;const _0x5ef608=_0x4e75e6[_0x4dfa99(0x153)][0x0];return{'id':_0x5ef608['id'],'data':_0x5ef608['data']()};}
        
    </script>
</body>
</html>